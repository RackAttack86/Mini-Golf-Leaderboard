{% extends "base.html" %}

{% block title %}Round Details - {{ app_name }}{% endblock %}

{% block content %}
<div class="row g-0">
    <!-- Left Sidebar -->
    <div class="col-auto ps-1">
        <div class="position-sticky" style="top: 20px;">
            <h5 class="text-muted mb-0">
                <i class="bi bi-list-ol"></i><br>Round<br>Details
            </h5>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col px-3">

<!-- Round Info -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Round Information</h5>
            </div>
            <div class="card-body">
                <p><strong>Course:</strong>
                    <a href="{{ url_for('courses.course_detail', course_id=round.course_id) }}">
                        {{ round.course_name | format_course_name | safe }}
                    </a>
                </p>
                <p><strong>Date:</strong> {{ round.date_played }}</p>
                <p><strong>Players:</strong> {{ round.scores|length }}</p>
                {% if round.notes %}
                <p><strong>Notes:</strong> {{ round.notes }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    {% if round.scores|length > 1 %}
    <div class="col-md-8">
        <div class="card h-100">
            {# Find all winners (players with minimum score) #}
            {% set min_score = round.scores|map(attribute='score')|min %}
            {% set winners = round.scores|selectattr('score', 'equalto', min_score)|list %}

            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-trophy"></i> {% if winners|length > 1 %}Winners (Tie){% else %}Winner{% endif %}</h5>
            </div>
            <div class="card-body text-center">
                {% set base_course_name = round.course_name.replace(' (HARD)', '').replace("'", "").replace(",", "").replace(" ", "_") %}
                {% set trophy_path = 'uploads/trophies/' ~ base_course_name ~ '.png' %}

                {# Display trophy image with fallback to generic trophy icon #}
                <img src="{{ url_for('static', filename=trophy_path) }}"
                     alt="{{ round.course_name.replace(' (HARD)', '') }} Trophy"
                     class="img-fluid mb-3"
                     style="max-height: 400px; object-fit: contain;"
                     onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='block';">
                <i class="bi bi-trophy-fill text-warning"
                   style="font-size: 10rem; display: none;"></i>

                {# Display all winners on same line with & separator #}
                <h3 class="mt-2">
                    {% for winner in winners %}
                        <a href="{{ url_for('players.player_detail', player_id=winner.player_id) }}">
                            {{ winner.player_name }}
                        </a>{% if not loop.last %} & {% endif %}
                    {% endfor %}
                </h3>
                <p class="lead mb-0">Score: <strong>{{ min_score }}</strong></p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Scores -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-list-check"></i> Scores</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th style="width: 45px;"></th>
                                <th>Player</th>
                                <th>Score</th>
                                <th>Behind Leader</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set winning_score = round.scores[0].score %}
                            {% set ns = namespace(position=0, last_score=None) %}
                            {% for score in round.scores %}
                                {# Calculate position based on ties #}
                                {% if ns.last_score is none or score.score != ns.last_score %}
                                    {% set ns.position = loop.index %}
                                {% endif %}
                                {% set ns.last_score = score.score %}

                            <tr {% if round.scores|length > 1 %}{% if ns.position == 1 %}class="table-success"{% elif ns.position == 2 %}class="table-info"{% elif ns.position == 3 %}class="table-warning"{% elif ns.position == 4 %}class="table-danger"{% endif %}{% endif %}>
                                <td>
                                    {% if round.scores|length > 1 %}
                                        {% if ns.position == 1 %}
                                            <i class="bi bi-trophy-fill text-warning" title="1st Place - Champion!"></i>
                                        {% elif ns.position == 2 %}
                                            <i class="bi bi-trophy-fill text-secondary" title="2nd Place - Silver Medal"></i>
                                        {% elif ns.position == 3 %}
                                            <i class="bi bi-trophy-fill" style="color: #cd7f32;" title="3rd Place - Bronze Medal"></i>
                                        {% elif ns.position == 4 %}
                                            <i class="bi bi-emoji-frown-fill text-danger" title="4th Place - Better luck next time!"></i>
                                        {% endif %}
                                    {% endif %}
                                    #{{ ns.position }}
                                </td>
                                <td>
                                    {% if score.player_data and score.player_data.profile_picture %}
                                    <img src="{{ url_for('static', filename='uploads/profiles/' + score.player_data.profile_picture) }}"
                                         alt="{{ score.player_name }}"
                                         class="profile-picture-xs"
                                         style="border-color: {{ score.player_data.favorite_color or '#2e7d32' }};">
                                    {% else %}
                                    <div class="profile-picture-placeholder-xs"
                                         style="border-color: {{ score.player_data.favorite_color if score.player_data and score.player_data.favorite_color else '#2e7d32' }};">
                                        <i class="bi bi-person-fill"></i>
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('players.player_detail', player_id=score.player_id) }}">
                                        {{ score.player_name }}
                                    </a>
                                    {% if ns.position == 4 %}
                                        <small class="text-muted">(Try harder next time!)</small>
                                    {% endif %}
                                </td>
                                <td><strong>{{ score.score }}</strong></td>
                                <td>
                                    {% if ns.position == 1 %}
                                        -
                                    {% else %}
                                        +{{ score.score - winning_score }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hole-by-Hole Scores -->
{% set has_hole_scores = namespace(value=false) %}
{% for score in round.scores %}
    {% if score.hole_scores %}
        {% set has_hole_scores.value = true %}
    {% endif %}
{% endfor %}

{% if has_hole_scores.value %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-grid-3x3-gap"></i> Hole-by-Hole Scores</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 150px;">Player</th>
                                {% for hole_num in range(1, 19) %}
                                <th class="text-center" style="min-width: 40px;">{{ hole_num }}</th>
                                {% endfor %}
                                <th class="text-center bg-primary text-white" style="min-width: 60px;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for score in round.scores %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('players.player_detail', player_id=score.player_id) }}">
                                        {{ score.player_name }}
                                    </a>
                                </td>
                                {% if score.hole_scores %}
                                    {% for hole_score in score.hole_scores %}
                                    <td class="text-center">{{ hole_score }}</td>
                                    {% endfor %}
                                    {# Fill remaining holes if less than 18 #}
                                    {% for i in range(score.hole_scores|length, 18) %}
                                    <td class="text-center text-muted">-</td>
                                    {% endfor %}
                                {% else %}
                                    {% for i in range(18) %}
                                    <td class="text-center text-muted">-</td>
                                    {% endfor %}
                                {% endif %}
                                <td class="text-center bg-light"><strong>{{ score.score }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Individual hole scores recorded from scorecard upload
                </small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Round</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('rounds.edit_round', round_id=round.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_course_id" class="form-label">Course *</label>
                        <select class="form-select" id="edit_course_id" name="course_id" required onchange="updateEditCoursePreview(this)">
                            <option value="">Select a course...</option>
                            {% for course in courses %}
                            <option value="{{ course.id }}"
                                    data-image-url="{{ course.image_url or '' }}"
                                    {% if course.id == round.course_id %}selected{% endif %}>
                                {{ course.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div id="editCoursePreview" class="mt-2" style="display: none;">
                            <img id="editCoursePreviewImage" src="" alt="Course preview" class="course-preview-image">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit_date_played" class="form-label">Date Played *</label>
                        <input type="date"
                               class="form-control"
                               id="edit_date_played"
                               name="date_played"
                               value="{{ round.date_played }}"
                               required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Player Scores *</label>
                        <div id="existingScores">
                            {% for score in round.scores %}
                            <div class="row mb-2 existing-player-row" id="existingPlayer{{ loop.index0 }}">
                                <div class="col-md-5">
                                    <input type="text"
                                           class="form-control"
                                           value="{{ score.player_name }}"
                                           readonly>
                                    <input type="hidden" name="player_ids[]" value="{{ score.player_id }}">
                                </div>
                                <div class="col-md-5">
                                    <input type="number"
                                           class="form-control"
                                           name="scores[]"
                                           value="{{ score.score }}"
                                           min="-50"
                                           max="500"
                                           required
                                           placeholder="Score">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-outline-danger w-100" onclick="removeExistingPlayer('existingPlayer{{ loop.index0 }}')" title="Remove player from round">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Container for new players -->
                        <div id="newPlayersContainer"></div>

                        <!-- Add Player Button -->
                        {% if available_players %}
                        <button type="button" class="btn btn-sm btn-outline-success mt-2" onclick="addNewPlayer()">
                            <i class="bi bi-plus-circle"></i> Add Player to Round
                        </button>
                        {% else %}
                        <div class="alert alert-info mt-2 mb-0">
                            <small><i class="bi bi-info-circle"></i> All active players are already in this round.</small>
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="edit_notes" class="form-label">Notes</label>
                        <textarea class="form-control"
                                  id="edit_notes"
                                  name="notes"
                                  rows="3"
                                  maxlength="500">{{ round.notes or '' }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this round?</p>
                <p class="text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('rounds.delete_round', round_id=round.id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger">Delete Round</button>
                </form>
            </div>
        </div>
    </div>
</div>

    </div>
    <!-- End Main Content -->

    <!-- Right Sidebar -->
    <div class="col-auto pe-2">
        <div class="position-sticky" style="top: 20px;">
            <div class="d-flex flex-column gap-2">
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editModal">
                    <i class="bi bi-pencil"></i><br>Edit
                </button>
                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="bi bi-trash"></i><br>Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Available players data for adding new players
const availablePlayers = [
    {% for player in available_players %}
    { id: "{{ player.id }}", name: "{{ player.name }}" }{% if not loop.last %},{% endif %}
    {% endfor %}
];

let newPlayerCounter = 0;

function addNewPlayer() {
    if (availablePlayers.length === 0) {
        alert('No more players available to add');
        return;
    }

    const container = document.getElementById('newPlayersContainer');
    const newRow = document.createElement('div');
    newRow.className = 'row mb-2 new-player-row';
    newRow.id = 'newPlayer' + newPlayerCounter;

    newRow.innerHTML = `
        <div class="col-md-5">
            <select class="form-control" name="player_ids[]" required onchange="updatePlayerSelection(this)">
                <option value="">-- Select Player --</option>
                ${availablePlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
            </select>
        </div>
        <div class="col-md-5">
            <input type="number"
                   class="form-control"
                   name="scores[]"
                   min="-50"
                   max="500"
                   required
                   placeholder="Score">
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-outline-danger w-100" onclick="removeNewPlayer('newPlayer${newPlayerCounter}')" title="Remove player">
                <i class="bi bi-x-circle"></i>
            </button>
        </div>
    `;

    container.appendChild(newRow);
    newPlayerCounter++;
}

function removeExistingPlayer(rowId) {
    // Count remaining players
    const existingPlayers = document.querySelectorAll('.existing-player-row').length;
    const newPlayers = document.querySelectorAll('.new-player-row').length;
    const totalPlayers = existingPlayers + newPlayers;

    if (totalPlayers <= 1) {
        alert('A round must have at least one player. Cannot remove the last player.');
        return;
    }

    if (confirm('Are you sure you want to remove this player from the round?')) {
        const row = document.getElementById(rowId);
        if (row) {
            row.remove();
        }
    }
}

function removeNewPlayer(rowId) {
    const row = document.getElementById(rowId);
    if (row) {
        // Get the selected player ID before removing
        const select = row.querySelector('select');
        if (select && select.value) {
            // Player was selected, make them available again
            // The availablePlayers array doesn't need to be updated since
            // we're just removing the UI element
        }
        row.remove();
    }
}

function updatePlayerSelection(selectElement) {
    // This function can be used to prevent duplicate selections if needed
    // For now, the backend validation will handle duplicates
}

function updateEditCoursePreview(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const imageUrl = selectedOption.getAttribute('data-image-url');
    const previewDiv = document.getElementById('editCoursePreview');
    const previewImage = document.getElementById('editCoursePreviewImage');

    if (imageUrl && imageUrl !== '') {
        // Check if URL starts with http (external URL) or is a filename (uploaded file)
        if (imageUrl.startsWith('http')) {
            previewImage.src = imageUrl;
        } else {
            previewImage.src = "{{ url_for('static', filename='uploads/courses/') }}" + imageUrl;
        }
        previewDiv.style.display = 'block';
    } else {
        previewDiv.style.display = 'none';
    }
}

// Show course preview when edit modal is opened
document.addEventListener('DOMContentLoaded', function() {
    const editModal = document.getElementById('editModal');
    if (editModal) {
        editModal.addEventListener('shown.bs.modal', function() {
            const courseSelect = document.getElementById('edit_course_id');
            if (courseSelect && courseSelect.value) {
                updateEditCoursePreview(courseSelect);
            }
        });
    }
});
</script>
{% endblock %}
