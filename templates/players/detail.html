{% extends "base.html" %}

{% block title %}{{ player.name }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <div class="d-flex align-items-center">
            {% if player.profile_picture %}
            <img src="{{ url_for('main.serve_profile_picture', filename=player.profile_picture) }}"
                 alt="{{ player.name }}"
                 class="profile-picture-lg me-3"
                 style="border-color: {{ player.favorite_color or '#2e7d32' }};">
            {% else %}
            <div class="profile-picture-placeholder-lg me-3"
                 style="border-color: {{ player.favorite_color or '#2e7d32' }};">
                <i class="bi bi-person-fill"></i>
            </div>
            {% endif %}
            <div>
                <h1 class="mb-1"><i class="bi bi-person"></i> {{ player.name }} <small class="text-muted">({{ achievements.total_points }} pts)</small></h1>
                {% if not player.active %}
                    <span class="badge bg-secondary">Inactive</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4 text-end">
        {% if current_user.is_authenticated and (current_user.is_admin or current_user.id == player.id) %}
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editModal">
            <i class="bi bi-pencil"></i> Edit
        </button>
        {% endif %}
        {% if current_user.is_authenticated and current_user.is_admin %}
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
            <i class="bi bi-trash"></i> Delete
        </button>
        {% endif %}
    </div>
</div>

<!-- Player Info -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Player Information</h5>
            </div>
            <div class="card-body">
                {% if current_user.is_authenticated and (current_user.is_admin or current_user.id == player.id) %}
                <p><strong>Email:</strong> {{ player.email or 'Not provided' }}</p>
                {% endif %}
                <p><strong>Meta Quest Username:</strong>
                    {% if player.meta_quest_username %}
                        <span class="badge bg-primary">{{ player.meta_quest_username }}</span>
                    {% else %}
                        <span class="text-muted">Not linked</span>
                    {% endif %}
                </p>
                <p><strong>Member Since:</strong> {{ player.created_at[:10] }}</p>
                <p><strong>Favorite Color:</strong>
                    <span class="color-swatch" style="background-color: {{ player.favorite_color or '#2e7d32' }};"></span>
                    {{ player.favorite_color or '#2e7d32' }}
                </p>
                <p><strong>Status:</strong>
                    {% if player.active %}
                        <span class="badge bg-success">Active</span>
                    {% else %}
                        <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Statistics</h5>
            </div>
            <div class="card-body">
                <p><strong>Total Rounds:</strong> {{ stats.total_rounds }}</p>
                <p><strong>Average Score:</strong> {{ stats.average_score if stats.average_score else 'N/A' }}</p>
                <p><strong>Best Score:</strong> {{ stats.best_score if stats.best_score else 'N/A' }}</p>
                <p><strong>Worst Score:</strong> {{ stats.worst_score if stats.worst_score else 'N/A' }}</p>
                <p><strong>Wins:</strong> {{ stats.wins }}</p>

                <!-- Placement Trophy Counts -->
                <div class="mt-3 d-flex align-items-center gap-4">
                    <div class="text-center">
                        <img src="{{ url_for('static', filename='images/trophies/GoldTrophy.png') }}"
                             alt="Gold Trophy"
                             style="width: 20%; max-width: 50px; object-fit: contain;">
                        <div><small><strong>{{ stats.gold_trophies }}</strong></small></div>
                    </div>
                    <div class="text-center">
                        <img src="{{ url_for('static', filename='images/trophies/SilverTrophy.png') }}"
                             alt="Silver Trophy"
                             style="width: 20%; max-width: 50px; object-fit: contain;">
                        <div><small><strong>{{ stats.silver_trophies }}</strong></small></div>
                    </div>
                    <div class="text-center">
                        <img src="{{ url_for('static', filename='images/trophies/BronzeTrophy.png') }}"
                             alt="Bronze Trophy"
                             style="width: 20%; max-width: 50px; object-fit: contain;">
                        <div><small><strong>{{ stats.bronze_trophies }}</strong></small></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Personal Bests -->
{% if personal_bests %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-star-fill"></i> Personal Bests by Course</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Best Score</th>
                                <th>Date Achieved</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pb in personal_bests %}
                            <tr class="clickable-row" data-href="{{ url_for('rounds.round_detail', round_id=pb.round_id) }}" style="cursor: pointer;">
                                <td>{{ pb.course_name | format_course_name | safe }}</td>
                                <td><span class="badge bg-success" style="font-size: 1rem;">{{ pb.score }}</span></td>
                                <td>{{ pb.date }}</td>
                                <td class="text-end">
                                    <a href="{{ url_for('rounds.round_detail', round_id=pb.round_id) }}"
                                       class="btn btn-sm btn-outline-primary stop-propagation">
                                        View Round
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Course Trophy Case -->
{% if owned_course_trophies %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-trophy-fill"></i> Course Trophy Case ({{ owned_course_trophies|length }})
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% for trophy in owned_course_trophies %}
                    <div class="col-md-3 col-sm-4 col-6">
                        <div class="card h-100 border-warning">
                            <div class="card-body text-center p-2">
                                <img src="{{ url_for('static', filename='uploads/trophies/' + trophy.difficulty + '/' + trophy.trophy_image) }}"
                                     alt="{{ trophy.course_name }} Trophy"
                                     class="img-fluid mb-2"
                                     style="max-height: 150px; object-fit: contain;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="text-muted mb-2" style="height: 150px; display: none; align-items: center; justify-content: center;">
                                    <i class="bi bi-trophy" style="font-size: 4rem;"></i>
                                </div>
                                <h6 class="mb-1" style="font-size: 0.85rem;">
                                    {{ trophy.course_name }}
                                </h6>
                                <small class="text-muted d-block">
                                    Won: {{ trophy.date_acquired }}
                                </small>
                                <small class="text-muted d-block">
                                    <a href="{{ url_for('rounds.round_detail', round_id=trophy.acquired_round_id) }}" class="text-decoration-none">
                                        View Round <i class="bi bi-arrow-right"></i>
                                    </a>
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Achievements -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-trophy-fill"></i> Achievements ({{ achievements.earned|length }}) - {{ achievements.total_points }} Points</h5>
            </div>
            <div class="card-body">
                {% if achievements.earned %}
                <div class="row g-3 mb-4">
                    {% for achievement in achievements.earned %}
                    <div class="col-md-4 col-lg-3">
                        <div class="achievement-badge earned" style="border-color: {{ achievement.color }};">
                            <div class="achievement-icon" style="background-color: {{ achievement.color }};">
                                <i class="{{ achievement.icon }}"></i>
                            </div>
                            <div class="achievement-details">
                                <h6 class="achievement-name">{{ achievement.name }}</h6>
                                <p class="achievement-description">{{ achievement.description }}</p>
                                <span class="badge bg-success">{{ achievement.points }} Points</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No achievements earned yet. Keep playing to unlock achievements!</p>
                {% endif %}

                {% if achievements.progress %}
                <h6 class="mt-4 mb-3">In Progress</h6>
                <div class="row g-3">
                    {% for achievement_id, prog in achievements.progress.items() %}
                    {% set achievement = achievements.earned|selectattr('id', 'equalto', achievement_id)|first or None %}
                    {% if not achievement %}
                    {% set ach_data = {
                        'first_round': {'name': 'First Round', 'description': 'Play your first round', 'icon': 'bi-play-circle', 'color': '#17a2b8', 'points': 10},
                        'getting_started': {'name': 'Getting Started', 'description': 'Play 5 rounds', 'icon': 'bi-flag', 'color': '#28a745', 'points': 20},
                        'regular': {'name': 'Regular', 'description': 'Play 10 rounds', 'icon': 'bi-star', 'color': '#ffc107', 'points': 30},
                        'veteran': {'name': 'Veteran', 'description': 'Play 25 rounds', 'icon': 'bi-award', 'color': '#fd7e14', 'points': 50},
                        'century_club': {'name': 'Century Club', 'description': 'Play 100 rounds', 'icon': 'bi-trophy', 'color': '#6f42c1', 'points': 100},
                        'first_victory': {'name': 'First Victory', 'description': 'Win your first round', 'icon': 'bi-trophy-fill', 'color': '#ffd700', 'points': 10},
                        'hat_trick': {'name': 'Hat Trick', 'description': 'Win 3 rounds', 'icon': 'bi-gem', 'color': '#28a745', 'points': 30},
                        'champion': {'name': 'Champion', 'description': 'Win 10 rounds', 'icon': 'bi-award-fill', 'color': '#dc3545', 'points': 60},
                        'dominator': {'name': 'Dominator', 'description': 'Win 25 rounds', 'icon': 'bi-star-fill', 'color': '#6f42c1', 'points': 100},
                        'legend': {'name': 'Legend', 'description': 'Win 50 rounds', 'icon': 'bi-lightning-fill', 'color': '#ff0000', 'points': 150},
                        'explorer': {'name': 'Explorer', 'description': 'Play on 3 different courses', 'icon': 'bi-compass', 'color': '#17a2b8', 'points': 20},
                        'world_traveler': {'name': 'World Traveler', 'description': 'Play on 5 different courses', 'icon': 'bi-globe', 'color': '#20c997', 'points': 40},
                        'course_master': {'name': 'Course Master', 'description': 'Play on 10 different courses', 'icon': 'bi-map', 'color': '#6610f2', 'points': 80},
                        'globe_trotter': {'name': 'Globe Trotter', 'description': 'Play on every course', 'icon': 'bi-globe2', 'color': '#8b5cf6', 'points': 80},
                        'standard_explorer': {'name': 'Standard Explorer', 'description': 'Play on all non-hard courses', 'icon': 'bi-compass-fill', 'color': '#3b82f6', 'points': 150},
                        'hardcore_champion': {'name': 'Hardcore Champion', 'description': 'Play on all hard courses', 'icon': 'bi-fire', 'color': '#dc2626', 'points': 200},
                        'course_conqueror': {'name': 'Course Conqueror', 'description': 'Win on every course', 'icon': 'bi-shield-fill-check', 'color': '#7c2d12', 'points': 500},
                        'social_butterfly': {'name': 'Social Butterfly', 'description': 'Play with 5 different players', 'icon': 'bi-people-fill', 'color': '#e83e8c', 'points': 40},
                        'party_animal': {'name': 'Party Animal', 'description': 'Play in a round with 4 or more players', 'icon': 'bi-emoji-smile-fill', 'color': '#ff6b6b', 'points': 10},
                        'hot_streak': {'name': 'Hot Streak', 'description': 'Win 3 rounds in a row', 'icon': 'bi-fire', 'color': '#ff6b35', 'points': 70},
                        'unstoppable': {'name': 'Unstoppable', 'description': 'Win 5 rounds in a row', 'icon': 'bi-rocket-takeoff-fill', 'color': '#d90429', 'points': 150}
                    }[achievement_id] %}
                    <div class="col-md-4 col-lg-3">
                        <div class="achievement-badge locked" style="border-color: #6c757d;">
                            <div class="achievement-icon" style="background-color: #6c757d;">
                                <i class="{{ ach_data.icon }}"></i>
                            </div>
                            <div class="achievement-details">
                                <h6 class="achievement-name">{{ ach_data.name }} ({{ ach_data.points }} pts)</h6>
                                <p class="achievement-description">{{ ach_data.description }}</p>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" role="progressbar"
                                         style="width: {% if prog.required > 0 %}{{ (prog.current / prog.required * 100)|int }}{% else %}0{% endif %}%; background-color: {{ ach_data.color }};"
                                         aria-valuenow="{{ prog.current }}" aria-valuemin="0" aria-valuemax="{{ prog.required }}">
                                        {{ prog.current }}/{{ prog.required }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Performance Trends Charts -->
{% if rounds %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Performance Trends</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <h6 class="text-center mb-3">Score Progression Over Time</h6>
                        <canvas id="scoreProgressionChart"></canvas>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <h6 class="text-center mb-3">Average Score by Course</h6>
                        <canvas id="avgScoreByCourseChart"></canvas>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-6 mx-auto mb-4">
                        <h6 class="text-center mb-3">Finishing Position Distribution</h6>
                        <canvas id="positionDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Recent Rounds -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-list-ol"></i> Round History</h5>
            </div>
            <div class="card-body">
                {% if rounds %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Course</th>
                                <th>Score</th>
                                <th>Result</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for round in rounds %}
                            <tr>
                                <td>{{ round.date_played }}</td>
                                <td>{{ round.course_name }}</td>
                                <td>
                                    {% for score in round.scores %}
                                        {% if score.player_id == player.id %}
                                            {{ score.score }}
                                        {% endif %}
                                    {% endfor %}
                                </td>
                                <td>
                                    {% set player_score = namespace(value=0) %}
                                    {% for score in round.scores %}
                                        {% if score.player_id == player.id %}
                                            {% set player_score.value = score.score %}
                                        {% endif %}
                                    {% endfor %}
                                    {% set min_score = round.scores|map(attribute='score')|min %}
                                    {% if player_score.value == min_score %}
                                        <span class="badge bg-success">Won</span>
                                    {% else %}
                                        {# Calculate player's position #}
                                        {% set position = namespace(value=1) %}
                                        {% for score in round.scores %}
                                            {% if score.score < player_score.value %}
                                                {% set position.value = position.value + 1 %}
                                            {% endif %}
                                        {% endfor %}
                                        <span class="badge bg-secondary">{{ position.value }}/{{ round.scores|length }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <a href="{{ url_for('rounds.round_detail', round_id=round.id) }}"
                                       class="btn btn-sm btn-outline-primary">
                                        View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No rounds played yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('players.edit_player', player_id=player.id) }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Name *</label>
                        <input type="text"
                               class="form-control"
                               id="edit_name"
                               name="name"
                               value="{{ player.name }}"
                               required
                               maxlength="100">
                    </div>
                    {% if current_user.is_authenticated and (current_user.is_admin or current_user.id == player.id) %}
                    <div class="mb-3">
                        <label for="edit_email" class="form-label">Email</label>
                        <input type="email"
                               class="form-control"
                               id="edit_email"
                               name="email"
                               value="{{ player.email or '' }}"
                               maxlength="100">
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <label for="edit_meta_quest_username" class="form-label">
                            Meta Quest Username
                            <i class="bi bi-info-circle text-muted" title="Link your Meta Quest account for automatic scorecard matching"></i>
                        </label>
                        <input type="text"
                               class="form-control"
                               id="edit_meta_quest_username"
                               name="meta_quest_username"
                               value="{{ player.meta_quest_username or '' }}"
                               maxlength="50"
                               placeholder="e.g. Sir_Chops">
                        <small class="text-muted">
                            This is your username in Walkabout Mini Golf, used to match uploaded scorecards to your profile.
                        </small>
                    </div>
                    <div class="mb-3">
                        <label for="edit_profile_picture" class="form-label">Profile Picture</label>
                        {% if player.profile_picture %}
                        <div class="mb-2">
                            <img src="{{ url_for('main.serve_profile_picture', filename=player.profile_picture) }}"
                                 alt="{{ player.name }}"
                                 class="profile-picture-preview">
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="remove_picture" id="remove_picture">
                                <label class="form-check-label" for="remove_picture">
                                    Remove current picture
                                </label>
                            </div>
                        </div>
                        {% endif %}
                        <input type="file"
                               class="form-control"
                               id="edit_profile_picture"
                               name="profile_picture"
                               accept="image/png,image/jpeg,image/jpg,image/gif">
                        <small class="text-muted">Accepted formats: JPG, PNG, GIF (max 5MB)</small>
                    </div>
                    <div class="mb-3">
                        <label for="edit_favorite_color" class="form-label">Favorite Color</label>
                        <input type="color"
                               class="form-control form-control-color"
                               id="edit_favorite_color"
                               name="favorite_color"
                               value="{{ player.favorite_color or '#2e7d32' }}"
                               title="Choose your favorite color">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>{{ player.name }}</strong>?</p>
                {% if stats.total_rounds > 0 %}
                <p class="text-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    This player has {{ stats.total_rounds }} round(s). The player will be deactivated instead of deleted.
                </p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('players.delete_player', player_id=player.id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ csp_nonce() }}">
document.addEventListener('DOMContentLoaded', function() {
    // Clickable rows
    document.querySelectorAll('.clickable-row').forEach(function(row) {
        row.addEventListener('click', function() {
            window.location = this.dataset.href;
        });
    });

    // Stop propagation on links inside rows
    document.querySelectorAll('.stop-propagation').forEach(function(el) {
        el.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
});
</script>
{% if rounds %}
<script nonce="{{ csp_nonce() }}">
// Prepare data from rounds
const rounds = {{ rounds | tojson }};
const playerId = "{{ player.id }}";
const playerColor = "{{ player.favorite_color or '#2e7d32' }}";

// Parse round data for charts
const chartData = {
    dates: [],
    scores: [],
    courseScores: {},  // {courseName: [scores]}
    positions: {1: 0, 2: 0, 3: 0, 4: 0}  // Count of 1st, 2nd, 3rd, 4th+ places
};

rounds.forEach(round => {
    // Find player's score in this round
    const playerScore = round.scores.find(s => s.player_id === playerId);
    if (!playerScore) return;

    // Score progression data
    chartData.dates.push(round.date_played);
    chartData.scores.push(playerScore.score);

    // Course average data
    if (!chartData.courseScores[round.course_name]) {
        chartData.courseScores[round.course_name] = [];
    }
    chartData.courseScores[round.course_name].push(playerScore.score);

    // Position distribution data
    const sortedScores = round.scores.map(s => s.score).sort((a, b) => a - b);
    const position = sortedScores.indexOf(playerScore.score) + 1;

    if (position === 1) chartData.positions[1]++;
    else if (position === 2) chartData.positions[2]++;
    else if (position === 3) chartData.positions[3]++;
    else chartData.positions[4]++;
});

// Calculate average scores by course
const courseNames = Object.keys(chartData.courseScores);
const courseAverages = courseNames.map(courseName => {
    const scores = chartData.courseScores[courseName];
    return (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
});

// Chart 1: Score Progression Over Time
const ctx1 = document.getElementById('scoreProgressionChart').getContext('2d');
new Chart(ctx1, {
    type: 'line',
    data: {
        labels: chartData.dates,
        datasets: [{
            label: 'Score',
            data: chartData.scores,
            borderColor: playerColor,
            backgroundColor: playerColor + '33',
            tension: 0.3,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    title: (items) => 'Date: ' + items[0].label,
                    label: (item) => 'Score: ' + item.formattedValue
                }
            }
        },
        scales: {
            y: {
                reverse: true,  // Lower scores are better in golf
                beginAtZero: false,
                title: {
                    display: true,
                    text: 'Score (lower is better)'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Date'
                }
            }
        }
    }
});

// Chart 2: Average Score by Course
const ctx2 = document.getElementById('avgScoreByCourseChart').getContext('2d');
new Chart(ctx2, {
    type: 'bar',
    data: {
        labels: courseNames,
        datasets: [{
            label: 'Average Score',
            data: courseAverages,
            backgroundColor: playerColor + '99',
            borderColor: playerColor,
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: (item) => 'Avg Score: ' + item.formattedValue
                }
            }
        },
        scales: {
            y: {
                reverse: true,
                beginAtZero: false,
                title: {
                    display: true,
                    text: 'Average Score (lower is better)'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Course'
                }
            }
        }
    }
});

// Chart 3: Position Distribution
const ctx3 = document.getElementById('positionDistributionChart').getContext('2d');
new Chart(ctx3, {
    type: 'doughnut',
    data: {
        labels: ['1st Place', '2nd Place', '3rd Place', '4th+ Place'],
        datasets: [{
            data: [
                chartData.positions[1],
                chartData.positions[2],
                chartData.positions[3],
                chartData.positions[4]
            ],
            backgroundColor: [
                '#ffc107',  // Gold for 1st
                '#c0c0c0',  // Silver for 2nd
                '#cd7f32',  // Bronze for 3rd
                '#6c757d'   // Gray for 4th+
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: (item) => item.label + ': ' + item.formattedValue + ' times'
                }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
