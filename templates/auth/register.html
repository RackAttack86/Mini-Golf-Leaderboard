{% extends "base.html" %}

{% block title %}Link Account - {{ app_name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-success text-white text-center">
                <h4 class="mb-0">
                    <i class="bi bi-link-45deg"></i> Link Your Account
                </h4>
            </div>
            <div class="card-body p-4">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Account Linking Required</strong><br>
                    To complete your sign-in, please link your Google account to an existing player profile.
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-3 text-muted">Your Google Account</h6>
                        <p class="mb-1">
                            <strong><i class="bi bi-person"></i> Name:</strong> {{ google_name }}
                        </p>
                        <p class="mb-0">
                            <strong><i class="bi bi-envelope"></i> Email:</strong> {{ google_email }}
                        </p>
                    </div>
                </div>

                <form method="POST" action="{{ url_for('auth.register') }}">
                    <div class="mb-4">
                        <label for="player_id" class="form-label">
                            <i class="bi bi-people"></i> Select Your Player Profile
                        </label>
                        <select class="form-select form-select-lg" id="player_id" name="player_id" required>
                            <option value="">-- Select a player --</option>
                            {% for player in unlinked_players %}
                            <option value="{{ player.id }}"
                                    {% if player.email == google_email %}selected{% endif %}>
                                {{ player.name }}
                                {% if player.email %}
                                    ({{ player.email }})
                                    {% if player.email == google_email %}
                                        <i class="bi bi-check-circle text-success"></i>
                                    {% endif %}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <i class="bi bi-lightbulb"></i>
                            {% if unlinked_players|selectattr('email', 'equalto', google_email)|list %}
                                We've pre-selected the profile matching your email address.
                            {% else %}
                                Select the player profile that belongs to you. If your profile email matches your Google email, it will be highlighted.
                            {% endif %}
                        </div>
                    </div>

                    {% if not unlinked_players %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>No Available Profiles</strong><br>
                        All player profiles are already linked to Google accounts. Please contact an administrator if you need assistance.
                    </div>
                    {% endif %}

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg" {% if not unlinked_players %}disabled{% endif %}>
                            <i class="bi bi-link-45deg"></i> Link Account & Sign In
                        </button>
                        <a href="{{ url_for('auth.login') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Cancel
                        </a>
                    </div>
                </form>

                {% if unlinked_players %}
                <hr class="my-4">
                <div class="text-muted small">
                    <p class="mb-0">
                        <i class="bi bi-shield-check"></i>
                        <strong>Note:</strong> Once linked, you can only sign in with this Google account. This helps keep your scores and profile secure.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="text-center mt-3">
            <a href="{{ url_for('main.index') }}" class="text-muted">
                <i class="bi bi-arrow-left"></i> Back to Home
            </a>
        </div>
    </div>
</div>
{% endblock %}
